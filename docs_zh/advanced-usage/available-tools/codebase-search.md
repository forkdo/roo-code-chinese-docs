---
description: 使用 AI 嵌入向量对整个代码库执行智能语义搜索，通过含义而非仅关键词查找相关代码。
keywords:
  - codebase_search
  - semantic search
  - AI embeddings
  - code search
  - Roo Code tools
  - vector search
  - Qdrant
---

# codebase_search

:::info 需要设置
`codebase_search` 工具是[代码库索引](/features/codebase-indexing)功能的一部分。它需要额外设置，包括嵌入向量提供程序和向量数据库。
:::

`codebase_search` 工具使用 AI 嵌入向量对整个代码库执行语义搜索。与传统的基于文本的搜索不同，它能理解查询的含义，即使在精确关键词不匹配的情况下也能找到相关代码。

---

## 参数

该工具接受以下参数：

- `query`（必需）：描述您要查找内容的自然语言搜索查询
- `path`（可选）：目录路径，用于将搜索范围限制在代码库的特定部分

---

## 功能说明

该工具使用语义相似性而非精确文本匹配来搜索已建立索引的代码库。它能找到与您的查询在概念上相关的代码块，即使它们不包含您搜索的确切词语。结果包括相关代码片段及其文件路径、行号和相似度分数。

---

## 使用场景

- 当 Roo 需要在项目中查找与特定功能相关的代码时
- 当查找实现模式或类似代码结构时
- 当搜索错误处理、身份验证或其他概念性代码模式时
- 当探索不熟悉的代码库以了解功能实现方式时
- 当查找可能受更改或重构影响的关联代码时

---

## 主要特性

- **语义理解**：通过含义而非精确关键词匹配查找代码
- **跨项目搜索**：搜索整个已建立索引的代码库，而不仅仅是打开的文件
- **上下文结果**：返回带有文件路径和行号的代码片段，便于导航
- **相似度评分**：结果按相关性排序，并带有相似度分数（0-1 分制）
- **范围过滤**：可选路径参数，用于将搜索限制在特定目录
- **智能排序**：结果按查询的语义相关性排序
- **UI 集成**：结果带有语法高亮和导航链接
- **性能优化**：基于向量的快速搜索，可配置结果限制

---

## 要求

此工具仅在代码库索引功能正确配置时可用：

- **功能已配置**：必须在设置中配置代码库索引
- **嵌入向量提供程序**：需要 OpenAI API 密钥或 Ollama 配置
- **向量数据库**：Qdrant 实例正在运行且可访问
- **索引状态**：代码库必须已建立索引（状态：“已索引”或“正在索引”）

---

## 限制

- **需要配置**：依赖外部服务（嵌入向量提供程序 + Qdrant）
- **索引依赖**：仅搜索已建立索引的代码块
- **结果限制**：每次搜索最多返回 50 个结果以保持性能
- **相似度阈值**：仅返回高于相似度阈值的结果（默认：0.4，可配置）
- **文件大小限制**：仅限于成功建立索引且小于 1MB 的文件
- **语言支持**：效果取决于 Tree-sitter 语言支持

---

## 工作原理

当调用 `codebase_search` 工具时，它遵循以下流程：

1. **可用性验证**：
   - 验证 CodeIndexManager 是否可用并已初始化
   - 确认代码库索引在设置中已启用
   - 检查索引是否正确配置（API 密钥、Qdrant URL）
   - 验证当前索引状态是否允许搜索

2. **查询处理**：
   - 获取您的自然语言查询并生成嵌入向量
   - 使用为索引配置的相同嵌入向量提供程序（OpenAI 或 Ollama）
   - 将查询的语义含义转换为数学表示

3. **向量搜索执行**：
   - 在 Qdrant 向量数据库中搜索相似的代码嵌入向量
   - 使用余弦相似度查找最相关的代码块
   - 应用最小相似度阈值（默认：0.4，可配置）以过滤结果
   - 将结果限制为 50 个匹配项以获得最佳性能

4. **路径过滤**（如果指定）：
   - 过滤结果，仅包含指定目录路径内的文件
   - 使用标准化路径比较进行准确过滤
   - 在过滤范围内保持相关性排序

5. **结果处理和格式化**：
   - 将绝对文件路径转换为工作区相对路径
   - 构建包含文件路径、行范围、相似度分数和代码内容的结构化结果
   - 为 AI 消费和 UI 显示（带有语法高亮）进行格式化

6. **双输出格式**：
   - **AI 输出**：带有查询、文件路径、分数和代码块的格式化文本
   - **UI 输出**：带有语法高亮和导航功能的 JSON 格式

---

## 搜索查询最佳实践

### 有效的查询模式

**良好：概念明确且具体**
```xml
<codebase_search>
<query>用户身份验证和密码验证</query>
</codebase_search>
```

**良好：以功能为中心**
```xml
<codebase_search>
<query>数据库连接池设置</query>
</codebase_search>
```

**良好：以问题为导向**
```xml
<codebase_search>
<query>API 请求的错误处理</query>
</codebase_search>
```

**效果较差：过于泛化**
```xml
<codebase_search>
<query>函数</query>
</codebase_search>
```

### 效果良好的查询类型

- **功能描述**：“文件上传处理”、“电子邮件验证逻辑”
- **技术模式**：“单例模式实现”、“工厂方法使用”
- **领域概念**：“用户配置文件管理”、“支付处理工作流”
- **架构组件**：“中间件配置”、“数据库迁移脚本”

---

## 目录范围限定

使用可选的 `path` 参数将搜索重点放在代码库的特定部分：

**在 API 模块中搜索：**
```xml
<codebase_search>
<query>端点验证中间件</query>
<path>src/api</path>
</codebase_search>
```

**在测试文件中搜索：**
```xml
<codebase_search>
<query>模拟数据设置模式</query>
<path>tests</path>
</codebase_search>
```

**在特定功能目录中搜索：**
```xml
<codebase_search>
<query>组件状态管理</query>
<path>src/components/auth</path>
</codebase_search>
```

---

## 结果解读

### 相似度分数

- **0.8-1.0**：高度相关的匹配项，很可能正是您要找的内容
- **0.6-0.8**：具有较强概念相似性的良好匹配项
- **0.4-0.6**：可能相关，但可能需要审查
- **低于 0.4**：因差异过大而被过滤掉

### 结果结构

每个搜索结果包括：
- **文件路径**：包含匹配项的文件的工作区相对路径
- **分数**：表示相关性的相似度分数（0.4-1.0）
- **行范围**：代码块的开始和结束行号
- **代码块**：与您的查询匹配的实际代码内容

---

## 使用示例

- 在实现新功能时，Roo 搜索“身份验证中间件”以了解现有模式，然后再编写新代码。
- 在调试问题时，Roo 搜索“API 调用中的错误处理”以在代码库中找到相关的错误模式。
- 在重构代码时，Roo 搜索“数据库事务模式”以确保所有数据库操作的一致性。
- 在加入新代码库时，Roo 搜索“配置加载”以了解应用程序的启动过程。

---

## 用法示例

在整个项目中搜索与身份验证相关的代码：
```xml
<codebase_search>
<query>用户登录和身份验证逻辑</query>
</codebase_search>
```

在特定目录中查找与数据库相关的代码：
```xml
<codebase_search>
<query>数据库连接和查询执行</query>
<path>src/data</path>
</codebase_search>
```

查找 API 代码中的错误处理模式：
```xml
<codebase_search>
<query>HTTP error responses and exception handling</query>
<path>src/api</path>
</codebase_search>
```

搜索测试工具和模拟设置：
```xml
<codebase_search>
<query>test setup and mock data creation</query>
<path>tests</path>
</codebase_search>
```

查找配置和环境设置代码：
```xml
<codebase_search>
<query>environment variables and application configuration</query>
</codebase_search>